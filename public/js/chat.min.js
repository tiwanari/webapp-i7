var last_message_id=0;function append(e){var a=e.content,n=e.user.display_name+"@"+e.user.name,t=e.date,s=e.user.avatar_icon,c=$('<div class="media message"></div>'),d=$('<div class="media-body">');$('<img class="avatar d-flex align-self-start mr-3" alt="no avatar">').attr("src","/icons/"+s).appendTo(c),$('<h5 class="mt-0"></h5>').append($("<a></a>").attr("href","/profile/"+e.user.name).text(n)).appendTo(d),$('<p class="content"></p>').text(a).appendTo(d),$('<p class="message-date"></p>').text(t).appendTo(d),d.appendTo(c),c.appendTo("#timeline"),last_message_id=Math.max(last_message_id,e.id);var o=$("div[class*='media message']");100<o.length&&o.slice(0,-100).remove()}function go_bottom(){$(window).scrollTop($(document).height())}function get_channel_id(){for(var e=window.location.pathname.split("/"),a=0;a<e.length;a++)if("channel"==e[a]&&e.length!=a+1)return e[a+1];return console.log(e),"1"}function fetch_unread(e){$.ajax({dataType:"json",async:!0,type:"GET",url:"/fetch",success:e})}function get_message(e){channel_id=get_channel_id(),msg_id=last_message_id,null!=channel_id?isNaN(msg_id)?console.error("last_message_id is NaN"):$.ajax({dataType:"json",async:!0,type:"GET",url:"/message",data:{last_message_id:last_message_id,channel_id:channel_id},success:function(a){e(a)}}):console.error("channel_id is null")}function post_message(e){channel_id=get_channel_id(),null!=channel_id?$.ajax({async:!0,type:"POST",url:"/message",data:{channel_id:channel_id,message:e}}):console.error("channel_id is null")}function on_send_button(){var e=$("#chatbox-textarea"),a=e.val();""!=a&&(post_message(a),e.val(""))}$(document).ready(function(){$("#chatbox-textarea").keydown(function(e){13!=e.keyCode||e.shiftKey||(on_send_button(),e.preventDefault())}),get_message(function(e){e.forEach(append);var a=!1;setInterval(function(){a||(a=!0,fetch_unread(function(e){console.log(e),channel_id=get_channel_id(),updated=!1,e.forEach(function(e){current_channel=e.channel_id==channel_id,current_channel&&0<e.unread&&(updated=!0);var a=$("#unread-"+e.channel_id);current_channel||0==e.unread?a.text(""):a.text(e.unread.toString())}),updated?get_message(function(e){0<e.length&&(e.forEach(append),go_bottom()),a=!1}):a=!1}))},10)})});